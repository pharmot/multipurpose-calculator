

<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>
      Source: pca.js - Multipurpose Calculator Documentation
  </title>

  <link href="https://www.braintreepayments.com/images/favicon-ccda0b14.png" rel="icon" type="image/png">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>

  <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
  <link type="text/css" rel="stylesheet" href="styles/jsdoc-custom.css">
  

  

  <!-- start Mixpanel -->
  <script type="text/javascript">(function(e,a){if(!a.__SV){var b=window;try{var c,l,i,j=b.location,g=j.hash;c=function(a,b){return(l=a.match(RegExp(b+"=([^&]*)")))?l[1]:null};g&&c(g,"state")&&(i=JSON.parse(decodeURIComponent(c(g,"state"))),"mpeditor"===i.action&&(b.sessionStorage.setItem("_mpcehash",g),history.replaceState(i.desiredHash||"",e.title,j.pathname+j.search)))}catch(m){}var k,h;window.mixpanel=a;a._i=[];a.init=function(b,c,f){function e(b,a){var c=a.split(".");2==c.length&&(b=b[c[0]],a=c[1]);b[a]=function(){b.push([a].concat(Array.prototype.slice.call(arguments,
  0)))}}var d=a;"undefined"!==typeof f?d=a[f]=[]:f="mixpanel";d.people=d.people||[];d.toString=function(b){var a="mixpanel";"mixpanel"!==f&&(a+="."+f);b||(a+=" (stub)");return a};d.people.toString=function(){return d.toString(1)+".people (stub)"};k="disable time_event track track_pageview track_links track_forms register register_once alias unregister identify name_tag set_config reset people.set people.set_once people.increment people.append people.union people.track_charge people.clear_charges people.delete_user".split(" ");
  for(h=0;h<k.length;h++)e(d,k[h]);a._i.push([b,c,f])};a.__SV=1.2;b=e.createElement("script");b.type="text/javascript";b.async=!0;b.src="undefined"!==typeof MIXPANEL_CUSTOM_LIB_URL?MIXPANEL_CUSTOM_LIB_URL:"file:"===e.location.protocol&&"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js".match(/^\/\//)?"https://cdn.mxpnl.com/libs/mixpanel-2-latest.min.js":"//cdn.mxpnl.com/libs/mixpanel-2-latest.min.js";c=e.getElementsByTagName("script")[0];c.parentNode.insertBefore(b,c)}})(document,window.mixpanel||[]);
  mixpanel.init("1919205b2da72e4da3b9b6639b444d59");</script>
  <!-- end Mixpanel -->
</head>

<body>
  <svg style="display: none;">
    <defs>
      <symbol id="linkIcon" fill="#706d77" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path d="M0 0h24v24H0z" fill="none"/>
          <path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/>
      </symbol>
    </defs>
  </svg>

  <input type="checkbox" id="nav-trigger" class="nav-trigger" />
  <label for="nav-trigger" class="navicon-button x">
    <div class="navicon"></div>
  </label>

  <label for="nav-trigger" class="overlay"></label>

  <div class="top-nav-wrapper">
    <ul>
      <li >
        <a href="index.html">
          
            <svg fill="#6D6D6D" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
              <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
              <path d="M0 0h24v24H0z" fill="none"/>
            </svg>
          
          
        </a>
      </li>

      

    </ul>
  </div>

  <nav>
    <h3 class="reference-title">Documentation</h3>

    

    <h3>Modules</h3><ul><li id="alligation-nav"><a href="module-alligation.html">alligation</a></li><li id="amg-nav"><a href="module-amg.html">amg</a></li><li id="arial-nav"><a href="module-arial.html">arial</a></li><li id="formValidation-nav"><a href="module-formValidation.html">formValidation</a></li><li id="growthCharts-nav"><a href="module-growthCharts.html">growthCharts</a></li><li id="heparin-nav"><a href="module-heparin.html">heparin</a></li><li id="ivig-nav"><a href="module-ivig.html">ivig</a></li><li id="kcentra-nav"><a href="module-kcentra.html">kcentra</a></li><li id="logger-nav"><a href="module-logger.html">logger</a></li><li id="nextdose-nav"><a href="module-nextdose.html">nextdose</a></li><li id="pca-nav"><a href="module-pca.html">pca</a></li><li id="qtc-nav"><a href="module-qtc.html">qtc</a></li><li id="secondDose-nav"><a href="module-secondDose.html">secondDose</a></li><li id="util-nav"><a href="module-util.html">util</a></li><li id="vanco-nav"><a href="module-vanco.html">vanco</a></li><li id="warf-nav"><a href="module-warf.html">warf</a></li></ul><h3>Namespaces</h3><ul><li id="calculate-nav"><a href="calculate.html">calculate</a></li><li id="heparin-nav"><a href="module-heparin-heparin.html">heparin</a></li><li id="kcentra-nav"><a href="module-kcentra-kcentra.html">kcentra</a></li><li id="pt-nav"><a href="pt.html">pt</a></li></ul><h3>Classes</h3><ul><li id="Pca-nav"><a href="module-pca-Pca.html">Pca</a></li><li id="Dose-nav"><a href="module-warf-Dose.html">Dose</a></li></ul><h3 id="global-nav">Global</h3><ul><li><a href="global.html#changedAmgMethod">changedAmgMethod</a></li><li><a href="global.html#displayChange">displayChange</a></li><li><a href="global.html#resetDates">resetDates</a></li><li><a href="global.html#vancoColorScale">vancoColorScale</a></li></ul><div class="repo-link">
    <svg height="32" aria-hidden="true" viewBox="0 0 16 16" version="1.1" width="32" data-view-component="true" class="octicon octicon-mark-github v-align-middle">
    <path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0016 8c0-4.42-3.58-8-8-8z"></path>
</svg>
    <a href="https://github.com/pharmot/multipurpose-calculator">Repository</a>
    </div>
  </nav>

  <div id="main">
    
      <h1 class="page-title">
        Source: pca.js
      </h1>
    

    
      

<section>
  <article>
    <pre class="prettyprint source linenums"><code>/**
 * PCA Calculatior Module
 * @module pca
 * @requires module:util
 * @requires module:formValidation
 * @since v1.1.0
 */

import { checkValue, displayValue } from './util.js';
import { default as setupValidation } from "./formValidation.js";

/** @type {PcaOptions[]} */
const guardrails = require('../lib/pcaGuardrails.json');

$('#pca-drug').on('change', changedDrug);
$('#pca-therapy').on('change', () => { changedDrug(false) } );
$('#pca-continuous').on('change', changedCi);
$('.input-pca').on('keyup', calcDose);

$("#btnReset").on("click", () => {
  $("#pca-drug")[0].selectedIndex = 0;
  $("#pca-therapy")[0].selectedIndex = 0;
  $("#pca-continuous")[0].selectedIndex = 0;
  $(".pca-bg-warning").removeClass("pca-bg-warning");
  $(".pca-bg-danger").removeClass("pca-bg-danger");
  $(".pca-bg-error").removeClass("pca-bg-error");
  changedDrug();
});

/** Class representing a PCA. */
class Pca {
  /**
   * Create a PCA.
   * @param {PcaOptions} opts - Parameters for this PCA
   */
  constructor(opts) {
    this.drugName = opts.drugName;
    this.therapy = opts.therapy;
    this.unit = opts.dosingUnit;
    this.concentration = opts.concentration;
    this.volume = opts.volume;
    this.limits = opts.limits;
    this.maxIncludesBolus = opts.maxIncludesBolus;
    return this;
  }
  /**
   * Get the full description of this PCA
   * @returns {String} Full description of drug/therapy and syringe
   */
  getFullDescription() {
    const _therapy = this.therapy.replace(/ \(.*\)/, '');
    return `${this.drugName} (${_therapy}) ${this.concentration * this.volume} ${this.unit}/${this.volume} mL`;
  }
}

const library = [];

guardrails.forEach( self => library.push( new Pca(self) ) );

let pca = library.filter(obj => obj.drugName === 'morphine' &amp;&amp; obj.therapy === 'Standard')[0];

let ci = 'none';

setupValidation([
  { selector: '#pca-bolusDose',  min: 0.01, max: 999 },
  { selector: '#pca-ciRate',     min: 0.01, max: 999 },
  { selector: '#pca-lockout',    min: 1,    max: 240 },
  { selector: '#pca-orderedMax', min: 0.01, max: 999 },
]);

/**
 * Called when drug selection is changed. Changes units, hour max interval, and pump limits displayed on form.
 * @param {Boolean} clearInputs - Default is to clear input fields when drug is changed. Set to false to keep values.
 * @returns {Null}
 */
function changedDrug(clearInputs = true) {
  const selectedDrug = $('#pca-drug')[0].value;
  const selectedTherapy = $('#pca-therapy')[0].value;

  pca = library.filter(obj => obj.drugName === selectedDrug &amp;&amp; obj.therapy === selectedTherapy)[0];
  
  $('.pca-pumplimit').html('');

  if ( clearInputs ) { $('.input-pca').val(null) }

  displayValue('#pca-pumplimit-load-min-soft', pca.limits.load.min.soft, -1, ` ${pca.unit}`);
  displayValue('#pca-pumplimit-load-max-soft', pca.limits.load.max.soft, -1, ` ${pca.unit}`);
  displayValue('#pca-pumplimit-load-max-hard', pca.limits.load.max.hard, -1, ` ${pca.unit}`);
  displayValue('#pca-pumplimit-pca-min-soft', pca.limits.pca.min.soft, -1, ` ${pca.unit}`);
  displayValue('#pca-pumplimit-pca-max-soft', pca.limits.pca.max.soft, -1, ` ${pca.unit}`);
  displayValue('#pca-pumplimit-pca-max-hard', pca.limits.pca.max.hard, -1, ` ${pca.unit}`);
  displayValue('#pca-pumplimit-continuous-min-soft', pca.limits.continuous.min.soft, -1, ` ${pca.unit}/hr`);
  displayValue('#pca-pumplimit-continuous-max-soft', pca.limits.continuous.max.soft, -1, ` ${pca.unit}/hr`);
  displayValue('#pca-pumplimit-continuous-max-hard', pca.limits.continuous.max.hard, -1, ` ${pca.unit}/hr`);
  displayValue('#pca-pumplimit-lockout-min-hard', pca.limits.lockout.min.hard, -1, ' min');
  displayValue('#pca-pumplimit-lockout-min-soft', pca.limits.lockout.min.soft, -1, ' min');
  displayValue('#pca-pumplimit-lockout-max-soft', pca.limits.lockout.max.soft, -1, ' min');
  displayValue('#pca-pumplimit-accumulated-min-soft', pca.limits.accumulated.min.soft, -1, ` ${pca.unit}/1 hr`);
  displayValue('#pca-pumplimit-accumulated-max-soft', pca.limits.accumulated.max.soft, -1, ` ${pca.unit}/1 hr`);
  displayValue('#pca-pumplimit-accumulated-max-hard', pca.limits.accumulated.max.hard, -1, ` ${pca.unit}/1 hr`);

  $('#pca-syringe').html( pca.getFullDescription() );
  $('.pca-units').html(pca.unit);
  $('.pca-unitsPerHour').html(`${pca.unit}/hr`);
  $('.pca-unitsPerOneHour').html(`${pca.unit}/1 hr`);
  calcDose();
}
/**
 * Called when continuous infusion selection is changed. Shows or hides relevant inputs and rows on form.
 * @returns {Null}
 */
function changedCi() {
  ci = $('#pca-continuous')[0].value;
  if ( ci !== 'overnight') {
    $('.pca-ci-night').addClass('hidden');
  } else {
    $('.pca-ci-night').removeClass('hidden');
  }
  if ( ci === 'none' ) {
    $('.pca-ci-only').addClass('hidden');
  } else {
    $('.pca-ci-only').removeClass('hidden');
  }
  calcDose();

}
/**
 * Calculates all outputs based on inputs and adds/removes shading in output/limit fields.
 * @returns {Null}
 */
function calcDose() {

  $('.pca-bg-warning').removeClass('pca-bg-warning');
  $('.pca-bg-danger').removeClass('pca-bg-danger');
  $('.pca-bg-error').removeClass('pca-bg-error');

  const bolus = checkValue($('#pca-bolusDose').val(), 0.01, 999);

  const lockout = checkValue($('#pca-lockout').val(), 1, 240);

  const max = checkValue($('#pca-orderedMax').val(), 0.01, 999);

  // Set rate to zero if rate input field is hidden
  const rate = ci === 'none' ? 0 : checkValue($('#pca-ciRate').val(), 0.01, 999, true);

  const syringeTotal = pca.concentration * pca.volume;

  const doseUnitPerHour = ` ${pca.unit}/hr`;

  const fromBolus = lockout === 0 ? 0 : 60 / lockout * bolus;
  displayValue("#pca-maxFromBolus", fromBolus, 0.1, doseUnitPerHour);
  displayValue("#pca-maxFromBolus2", fromBolus, 0.1, doseUnitPerHour);

  const fromInfusionDay = ci === 'continuous' ? rate : 0;

  const fromInfusionNight = (ci !== 'none' ? rate : 0) || 0;

  displayValue("#pca-amtFromCI", fromInfusionNight, 0.1, doseUnitPerHour);

  if ( ci === 'night' &amp;&amp; fromInfusionNight > 0 ) {
    $('#pca-amtFromCI-day').html('---');
  } else {
    $('#pca-amtFromCI-day').html('');
  }

  const preMaxDay = fromInfusionDay + fromBolus;
  displayValue('#pca-totalAmtPossible-day', preMaxDay, 0.1, doseUnitPerHour);

  const preMaxNight = fromInfusionNight + fromBolus;
  displayValue('#pca-totalAmtPossible-night', preMaxNight, 0.1, doseUnitPerHour);

  const dispFreqDay =  syringeTotal / preMaxDay;
  displayValue('#pca-maxDispenseFreq-day', dispFreqDay, 0.1, ' hr');

  const dispFreqNight =  syringeTotal / preMaxNight;
  displayValue('#pca-maxDispenseFreq-night', dispFreqNight, 0.1, ' hr');

  let forBolusDay = max - fromInfusionDay;
  let forBolusNight = max - fromInfusionNight;

  if ( forBolusDay &lt;= 0 &amp;&amp; max > 0 ) {
    $('#pca-availableForBolus-day').html('max &amp;le; CI').addClass('pca-bg-error');
    forBolusDay = 0;
  } else {
    displayValue('#pca-availableForBolus-day', forBolusDay, 0.1, doseUnitPerHour);
  }

  if ( forBolusNight &lt;= 0 &amp;&amp; max > 0 ) {
    $('#pca-availableForBolus-night').html('max &amp;le; CI').addClass('pca-bg-error');
    forBolusNight = 0;
  } else {
    displayValue('#pca-availableForBolus-night', forBolusNight, 0.1, doseUnitPerHour);
  }

  const avgLockoutDay = max > 0 ? 60 / (  forBolusDay / bolus ) : 0;
  const avgLockoutNight = max > 0 ?  60 / (  forBolusNight / bolus ) : 0;


  if ( forBolusDay &lt; bolus &amp;&amp; max > 0 ) {
    $('#pca-averageFreq-day').html('---').addClass('pca-bg-error');
  } else {
    displayValue('#pca-averageFreq-day', avgLockoutDay, 0.1, ' min', 'q ');
    if ( lockout > 0 &amp;&amp; avgLockoutDay > lockout ) {
      $('#pca-averageFreq-day').addClass('pca-bg-warning');
    }
  }

  if ( forBolusNight &lt; bolus &amp;&amp; max > 0 ) {
    $('#pca-averageFreq-night').html('---').addClass('pca-bg-error');
  } else {
    displayValue('#pca-averageFreq-night', avgLockoutNight, 0.1, ' min', 'q ');
    if ( lockout > 0 &amp;&amp; avgLockoutNight > lockout ) {
      $('#pca-averageFreq-night').addClass('pca-bg-warning');
    }
  }

  const finalDispFreq =  syringeTotal / max;

  displayValue('#pca-maxDispenseFreq-final', finalDispFreq, 0.1, ' hr');

  checkPumpLimits(pca.limits, {
    pca: bolus,
    rate: rate,
    max: max,
    lockout: lockout,
  });
}
/**
 * Checks settings against pump limits and adds classes (background colors)
 * to limit table if settings exceed parameters.
 *
 * @param   {PcaLimitSet} pcaLimits  - Limits for current PCA
 * @param   {PcaParams}   pcaOrdered - Current ordered PCA parameters
 */
function checkPumpLimits(pcaLimits, pcaOrdered) {
  const arr = [
    {
      value: pcaOrdered.pca,
      limits: pcaLimits.pca,
      softMinSelector: '#pca-pumplimit-pca-min-soft',
      softMaxSelector: '#pca-pumplimit-pca-max-soft',
      hardMaxSelector: '#pca-pumplimit-pca-max-hard',
    },
    {
      value: pcaOrdered.rate,
      limits: pcaLimits.continuous,
      softMinSelector: '#pca-pumplimit-continuous-min-soft',
      softMaxSelector: '#pca-pumplimit-continuous-max-soft',
      hardMaxSelector: '#pca-pumplimit-continuous-max-hard',
    },
    {
      value: pcaOrdered.lockout,
      limits: pcaLimits.lockout,
      hardMinSelector: '#pca-pumplimit-lockout-min-hard',
      softMinSelector: '#pca-pumplimit-lockout-min-soft',
      softMaxSelector: '#pca-pumplimit-lockout-max-soft',
    },
    {
      value: pcaOrdered.max,
      limits: pcaLimits.accumulated,
      softMinSelector: '#pca-pumplimit-accumulated-min-soft',
      softMaxSelector: '#pca-pumplimit-accumulated-max-soft',
      hardMaxSelector: '#pca-pumplimit-accumulated-max-hard',
    },
  ];

  arr.forEach( me => {

    const hardMin = me.limits.min.hard || 0;
    const softMin = me.limits.min.soft || 0;
    const hardMax = me.limits.max.hard || 9999;
    const softMax = me.limits.max.soft || 9999;

    if ( me.value !== undefined &amp;&amp; me.value > 0 ) {
      if ( me.value &lt; hardMin ) {
        $(me.hardMinSelector).addClass('pca-bg-danger');
        $(me.softMinSelector).addClass('pca-bg-danger');
      } else if ( me.value &lt; softMin ) {
        $(me.softMinSelector).addClass('pca-bg-warning');
      } else if ( me.value > hardMax ) {
        $(me.hardMaxSelector).addClass('pca-bg-danger');
        $(me.softMaxSelector).addClass('pca-bg-danger');
      } else if ( me.value > softMax ) {
        $(me.softMaxSelector).addClass('pca-bg-warning');
      }
    }

  });
}

/**
 * PCA Order Parameters
 *
 * @typedef  {Object} PcaParams
 * @property {Number} pca     - patient-delivered PCA dose
 * @property {Number} rate    - continuous infusion rate per hour
 * @property {Number} lockout - lockout interval in minutes
 * @property {Number} max     - max accumulated dose in one hour
 */

/**
 * PCA Options for one drug and therapy
 *
 * @typedef  {Object} PcaOptions
 * @property {String}      drugName         - Drug name
 * @property {String}      dosingUnit       - Unit (mg or mcg)
 * @property {Number}      concentration    - Concentration in &lt;unit> per mL
 * @property {Number}      volume           - Total volume of PCA in mL
 * @property {Boolean}     maxIncludesBolus - Whether clinician-delivered bolus is included in accumulated dose calculation
 * @property {PcaLimitSet} limits           - Alaris Guardrails PCA settings
 */

/**
 * Alaris Guardrails PCA Limits for one drug and therapy
 *
 * @typedef  {Object} PcaLimitSet
 * @property {PcaLimitMinMax} pca         - Limits for patient-delivered PCA dose
 * @property {PcaLimitMinMax} continuous  - Limits for continuous infusion rate per hour
 * @property {PcaLimitMinMax} bolus       - Limits for clinician-delivered bolus
 * @property {PcaLimitMinMax} load        - Limits for clinician-delivered loading dose
 * @property {PcaLimitMinMax} lockout     - Limits for lockout interval in minutes
 * @property {PcaLimitMinMax} accumulated - Limits for max accumulated dose in one hour
 */

/**
 * All values for one type of PCA limit
 *
 * @typedef  {Object} PcaLimitMinMax
 * @property {PcaLimit} min - Minimum limits
 * @property {PcaLimit} max - Maximum limits
 */

/**
 * Hard and soft limits. null if not applicable, 0 if not set.
 *
 * @typedef  {Object} PcaLimit
 * @property {Number} soft - Soft limit
 * @property {Number} hard - Hard limit
 */</code></pre>
  </article>
</section>

    


  </div>

  <br class="clear">

  <footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.11</a>
  </footer>

  <script src="scripts/linenumber.js"></script>
  <script src="scripts/pagelocation.js"></script>

  

</body>
</html>
